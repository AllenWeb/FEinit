#!/usr/bin/env node

var fs = require('fs');
var nopt = require('nopt');
var join = require('path').join;
var help = join(__dirname, 'help.txt'); //帮助文件
var config = join(__dirname, '../', 'config.json'); //默认配置文件
var path = require('path');
var grunt = require('grunt');

var root = join(__dirname, '../');
var feEvent = require(root + '/lib/feEvent');
feEvent = new feEvent();
// var cli = require('../lib/node_modules/grunt/lib/grunt/cli');
// var cmds = cli.tasks,
//     route = cmds.join(' ').trim('');

var opts = nopt({
    help: Boolean
}, {
    h: '--help',
    v: '--version'
});
var cmds = opts.argv.cooked;


//显示帮助
if (cmds.indexOf('--help') !== -1) {
    feEvent.help();
    return;
}
//显示版本
if (cmds.indexOf('--version') !== -1) {
    return console.log('fe v%s', require('../package.json').version);
}
//config 命令
var str = cmds.join(' ');
if (str === 'config list') {
    return fs.createReadStream(config).pipe(process.stdout);
} else if (str.indexOf('config get') === 0) {

    cmds = cmds.slice(2);
    var json = require(config);
    var isArray = require('util').isArray;
    cmds.forEach(function(v) {
        var str = function(s) {
            if (isArray(s) || typeof s === 'object') {
                return JSON.stringify(s, null, 4);

            }
            return s;
        }(json[v]);
        console.log(v + '==>\n' + str);
    });
    return;
} else if (str === 'config edit') {
    var spawn = require('child_process').spawn;
    // spawn('notepad',[config]);
    spawn('explorer', [config]);
    return;
} else if (str === 'config open') {
    var spawn = require('child_process').spawn;
    spawn('explorer', [config]);
    return;
} else if (str === 'task list') {
    feEvent.taskList();
    return;
}

//调用tasks里面的grunt任务
var findup = require('findup-sync');
var exeRoute = findup('./');
if (cmds.indexOf('init') !== -1) {
    var FE = require(root + '/lib/FEinit');
    FE.init(exeRoute).start();
    return;
}


var Task = require(root + '/lib/task');
var task = new Task(exeRoute, cmds);
task.run();
// return;
// var grunt = require('grunt');
// grunt.loadTasks(root + '/tasks');
// // console.log(grunt.task);
// // return;
// grunt.task.run(cmds).start();